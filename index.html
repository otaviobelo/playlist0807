<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leitor de CSV</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    .resumo {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin: 20px 0;
    }

    .card {
      flex: 1;
      border-radius: 8px;
      padding: 16px;
      color: #fff;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      min-width: 180px;
    }

    .receita { background-color: #4CAF50; }
    .despesa { background-color: #F44336; }
    .saldo   { background-color: #2196F3; }

    .categoria-card {
      background-color: #444;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      min-width: 200px;
    }

    .categoria-card h3 {
      margin: 0 0 6px;
      font-size: 16px;
    }

    .categoria-card .receita,
    .categoria-card .despesa {
      color: white;
    }

    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: auto;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      overflow: auto;
      white-space: nowrap;
    }

    th {
      background-color: #f0f0f0;
      resize: horizontal;
      min-width: 100px;
      max-width: 600px;
    }

    td.valor, th.valor, td.saldo, th.saldo {
      text-align: right;
    }
  </style>
</head>
<body>
  <h1>Leitor de CSV</h1>
  <input type="file" id="csvFile" accept=".csv" />

  <!-- Filtro por período -->
  <div style="margin: 20px 0;">
    <label for="dataInicio">De: </label>
    <input type="date" id="dataInicio" />

    <label for="dataFim">Até: </label>
    <input type="date" id="dataFim" />

    <button id="btnFiltrar">Filtrar</button>
  </div>

  <!-- Totais gerais -->
  <div id="resumoTotais" class="resumo" style="display: none;">
    <div class="card receita" id="receitaCard">Receitas: R$ 0,00</div>
    <div class="card despesa" id="despesaCard">Despesas: R$ 0,00</div>
    <div class="card saldo" id="saldoCard">Saldo: R$ 0,00</div>
  </div>

  <!-- Resumo por categoria -->
  <div id="resumoCategorias" class="resumo"></div>

  <!-- Tabela -->
  <div id="tableContainer"></div>

  <script>
    const CATEGORIAS_BASE = [
      'Moradia', 'Transporte', 'Alimentação', 'Educação', 'Saúde', 'Lazer',
      'Compras', 'Financeiras', 'Outros', 'Salário', 'Freelancer', 'Aluguel Recebido',
      'Investimentos', 'Vendas', 'Cashback', 'Transferência Recebida', 'Estorno',
      'Aposentadoria', 'Ajuda'
    ];

    const CATEGORIAS_PALAVRAS = {
      'salário': 'Salário',
      'pix - recebido': 'Transferência Recebida',
      'pix - enviado': 'Transferência Recebida',
      'supermercado': 'Alimentação',
      'posto': 'Transporte',
      'rende fácil': 'Investimentos',
      'cartão': 'Financeiras',
    };

    const categoriaStorage = JSON.parse(localStorage.getItem('categoriasPersonalizadas') || '{}');
    let dadosCSV = [];

    function detectarCategoria(historico) {
      const texto = historico.toLowerCase();
      if (categoriaStorage[texto]) return categoriaStorage[texto];
      for (const chave in CATEGORIAS_PALAVRAS) {
        if (texto.includes(chave)) {
          return CATEGORIAS_PALAVRAS[chave];
        }
      }
      return 'Outros';
    }

    function detectarTipo(valor) {
      if (valor > 0) return 'Receita';
      if (valor < 0) return 'Despesa';
      return '';
    }

    function parseValor(valorStr) {
      if (!valorStr) return 0;
      const partes = valorStr.split(',');
      if (partes.length === 2) {
        const parteInteira = partes[0].replace(/\./g, '');
        const parteDecimal = partes[1];
        return parseFloat(`${parteInteira}.${parteDecimal}`);
      }
      return parseFloat(valorStr.replace(',', '.'));
    }

    function formatarValorBrasileiro(valor) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(valor);
    }

    function filtrarPorData(data) {
      const inicio = document.getElementById('dataInicio').value;
      const fim = document.getElementById('dataFim').value;

      if (!inicio && !fim) return data;

      return data.filter((row, i) => {
        if (i < 2 || i === data.length - 1) return true;
        const dataLancamento = row[0]?.split(' ')[0]?.split('/').reverse().join('-');
        if (inicio && dataLancamento < inicio) return false;
        if (fim && dataLancamento > fim) return false;
        return true;
      });
    }

    document.getElementById('csvFile').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (event) {
        const binaryStr = event.target.result;
        const decoder = new TextDecoder('windows-1252');
        const text = decoder.decode(new Uint8Array(binaryStr.split('').map(c => c.charCodeAt(0))));
        const rows = text.trim().split('\n').map(row =>
          row.split(',').map(cell => cell.replace(/^"|"$/g, ''))
        );

        dadosCSV = rows;
        const filtrados = filtrarPorData(dadosCSV);
        renderTotaisGerais(filtrados);
        renderResumoPorCategoria(filtrados);
        renderTable(filtrados);
      };
      reader.readAsBinaryString(file);
    });

    document.getElementById('btnFiltrar').addEventListener('click', () => {
      const filtrados = filtrarPorData(dadosCSV);
      renderTotaisGerais(filtrados);
      renderResumoPorCategoria(filtrados);
      renderTable(filtrados);
    });

    function renderTotaisGerais(data) {
      let receita = 0;
      let despesa = 0;

      data.slice(2, -1).forEach(row => {
        const valor = parseValor(row[5]);
        if (valor > 0) receita += valor;
        else despesa += Math.abs(valor);
      });

      const saldo = receita - despesa;

      document.getElementById('receitaCard').textContent = `Receitas: R$ ${formatarValorBrasileiro(receita)}`;
      document.getElementById('despesaCard').textContent = `Despesas: R$ ${formatarValorBrasileiro(despesa)}`;
      document.getElementById('saldoCard').textContent = `Saldo: R$ ${formatarValorBrasileiro(saldo)}`;
      document.getElementById('resumoTotais').style.display = 'flex';
    }

    function renderResumoPorCategoria(data) {
      const resumo = {};
      data.slice(2, -1).forEach(row => {
        const historico = row[2] || '';
        const valor = parseValor(row[5]);
        const tipo = detectarTipo(valor);
        const categoria = detectarCategoria(historico);

        if (!resumo[categoria]) resumo[categoria] = { receita: 0, despesa: 0 };
        if (tipo === 'Receita') resumo[categoria].receita += valor;
        if (tipo === 'Despesa') resumo[categoria].despesa += Math.abs(valor);
      });

      const container = document.getElementById('resumoCategorias');
      container.innerHTML = '';

      for (const categoria in resumo) {
        const bloco = document.createElement('div');
        bloco.className = 'categoria-card';
        bloco.innerHTML = `
          <h3>${categoria}</h3>
          <div class="receita">Receita: R$ ${formatarValorBrasileiro(resumo[categoria].receita)}</div>
          <div class="despesa">Despesa: R$ ${formatarValorBrasileiro(resumo[categoria].despesa)}</div>
        `;
        container.appendChild(bloco);
      }
    }

    function renderTable(data) {
      const container = document.getElementById('tableContainer');
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const headerRow = document.createElement('tr');
      data[0].forEach(cell => {
        const th = document.createElement('th');
        th.textContent = cell;
        if (cell.toLowerCase() === 'valor') th.classList.add('valor');
        headerRow.appendChild(th);
      });

      ['Tipo', 'Categoria', 'Saldo'].forEach(label => {
        const th = document.createElement('th');
        th.textContent = label;
        if (label === 'Saldo') th.classList.add('saldo');
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);

      let saldo = parseValor(data[1][5]);

      data.slice(1).forEach((row, index, arr) => {
        const isFirst = index === 0;
        const isLast = index === arr.length - 1;

        const tr = document.createElement('tr');
        row.forEach((cell, i) => {
          const td = document.createElement('td');
          if (data[0][i].toLowerCase() === 'valor') {
            const numero = parseValor(cell);
            td.textContent = formatarValorBrasileiro(numero);
            td.classList.add('valor');
          } else {
            td.textContent = cell;
          }
          tr.appendChild(td);
        });

        const valor = parseValor(row[5]);
        const historico = row[2] || '';
        const tipo = detectarTipo(valor);
        const categoriaDetectada = detectarCategoria(historico);

        const tipoTd = document.createElement('td');
        tipoTd.textContent = tipo;
        tr.appendChild(tipoTd);

        const categoriaTd = document.createElement('td');
        const select = document.createElement('select');
        [...CATEGORIAS_BASE, 'Outros'].forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          if (cat === categoriaDetectada) option.selected = true;
          select.appendChild(option);
        });

        select.addEventListener('change', () => {
          categoriaStorage[historico.toLowerCase()] = select.value;
          localStorage.setItem('categoriasPersonalizadas', JSON.stringify(categoriaStorage));
          const filtrados = filtrarPorData(dadosCSV);
          renderResumoPorCategoria(filtrados);
          renderTotaisGerais(filtrados);
        });

        categoriaTd.appendChild(select);
        tr.appendChild(categoriaTd);

        const tdSaldo = document.createElement('td');
        tdSaldo.classList.add('saldo');

        if (!isFirst && !isLast) {
          saldo += valor;
          tdSaldo.textContent = formatarValorBrasileiro(saldo);
        } else {
          tdSaldo.textContent = '';
        }

        tr.appendChild(tdSaldo);
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }
  </script>
</body>
</html>
